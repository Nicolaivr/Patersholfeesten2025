<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Patersholfeesten 2025 - Festival Tijdlijn</title>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', Arial, sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 0;
      color: #222;
    }
    header {
      background: #2e3d51;
      color: #fff;
      padding: 2rem 1rem 1rem 1rem;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    header h1 {
      margin: 0;
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: 2px;
    }
    header p {
      margin: 0.5rem 0 0 0;
      font-size: 1.15rem;
      font-weight: 400;
    }
    .timeline-container {
      max-width: 1300px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .timeline-date {
      font-size: 1.4rem;
      font-weight: 700;
      color: #2e3d51;
      margin: 2.5rem 0 1rem 0;
      border-left: 5px solid #2e3d51;
      padding-left: 0.8em;
      background: #ebeff5;
    }
    .timeline-grid {
      display: grid;
      grid-template-columns: 80px repeat(var(--stage-count), 1fr);
      gap: 0;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      overflow: hidden;
    }
    .timeline-header {
      background: #e3eaf4;
      color: #2e3d51;
      font-weight: 600;
      text-align: center;
      padding: 0.6em 0.2em;
      border-bottom: 1px solid #d9e3f0;
      font-size: 1.05rem;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .timeline-time {
      background: #f5f7fb;
      font-weight: 600;
      font-size: 1.02em;
      color: #2e3d51;
      text-align: right;
      padding: 0.4em 0.8em 0.4em 0.2em;
      border-right: 1px solid #e3eaf4;
      border-bottom: 1px solid #e3eaf4;
      min-height: 2.5em;
      box-sizing: border-box;
    }
    .timeline-cell {
      border-bottom: 1px solid #e3eaf4;
      min-height: 2.5em;
      padding: 0.3em 0.4em;
      box-sizing: border-box;
      position: relative;
      background: #fff;
    }
    .timeline-cell.event {
      background: #eafaf5;
      border-left: 5px solid #1abc9c;
      font-weight: 500;
      color: #212;
    }
    .timeline-cell.event.stage-kaatsspelplein { border-left-color: #1abc9c; background: #eafaf5; }
    .timeline-cell.event.stage-viersprong { border-left-color: #e67e22; background: #fcf3eb; }
    .timeline-cell.event.stage-algemeen { border-left-color: #2e3d51; background: #f2f5fa; }

    .event-title { font-weight: bold; }
    .event-info { font-size: 0.95em; color: #445; }
    .event-time { font-size: 0.92em; font-style: italic; color: #555; }

    @media (max-width: 800px) {
      .timeline-header, .timeline-time, .timeline-cell { font-size: 0.97rem; }
      header h1 { font-size: 2rem; }
      .timeline-container { padding: 0 0.2rem; }
      .timeline-grid { font-size: 0.93rem; }
    }
    @media (max-width: 600px) {
      .timeline-grid { font-size: 0.88rem; }
      .timeline-header { font-size: 0.94rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Patersholfeesten 2025</h1>
    <p>Festival Tijdlijn &mdash; Overzicht per dag en per podium v2</p>
  </header>
  <main>
    <div class="timeline-container" id="timeline"></div>
  </main>
  <script>
    // Utility: pad time string to HH:MM
    function padTime(t) {
      return t.length === 5 ? t : t.length === 4 ? '0' + t : t;
    }

    // Create array of time slots (e.g. every 30 minutes)
    function createTimeSlots(events, slotMinutes = 30) {
      // Find min and max times for the day
      let min = '24:00', max = '00:00';
      for (const ev of events) {
        if (ev.start < min) min = ev.start;
        if (ev.end > max) max = ev.end;
      }
      min = padTime(min);
      max = padTime(max);

      const slots = [];
      let [h, m] = min.split(':').map(Number);
      const [maxh, maxm] = max.split(':').map(Number);

      while (h < maxh || (h === maxh && m <= maxm)) {
        slots.push(`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`);
        m += slotMinutes;
        if (m >= 60) { h += 1; m -= 60; }
      }
      return slots;
    }

    // For each stage, for each time slot, show event if it is ongoing
    function renderDayGrid(date, events, stages, slotMinutes = 30) {
      const slots = createTimeSlots(events, slotMinutes);
      const stageMap = {};
      stages.forEach(s => stageMap[s] = []);
      // Build for each stage a list of its events
      for (const ev of events) {
        stageMap[ev.stage].push(ev);
      }

      // For fast lookup, for each stage, for each slot, find covering event (if any)
      const grid = [];
      for (let i = 0; i < slots.length; ++i) {
        const slot = slots[i];
        const row = [];
        for (const stage of stages) {
          // Find an event that covers this slot but only show at the start time, and span for duration
          const ev = stageMap[stage].find(e =>
            padTime(e.start) === slot
          );
          row.push(ev || null);
        }
        grid.push(row);
      }

      // For rowspan logic
      function getRowSpan(stage, rowIdx) {
        const ev = grid[rowIdx][stage];
        if (!ev) return 1;
        // Count how many slots this event covers, starting at rowIdx
        let count = 1;
        const slotsStart = padTime(ev.start);
        const slotsEnd = padTime(ev.end);
        let curIdx = rowIdx + 1;
        while (curIdx < slots.length) {
          const curSlot = slots[curIdx];
          // If end time <= current slot, stop
          if (curSlot >= slotsEnd) break;
          curIdx++;
          count++;
        }
        return count;
      }

      // HTML
      let html = `<div class="timeline-date">${new Date(date).toLocaleDateString('nl-NL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>`;
      html += `<div class="timeline-grid" style="--stage-count:${stages.length}">`;

      // Header row
      html += `<div class="timeline-header"></div>`;
      for (const stage of stages) {
        html += `<div class="timeline-header">${stage.charAt(0).toUpperCase() + stage.slice(1)}</div>`;
      }

      // Build slot rows
      const stageIdxMap = Object.fromEntries(stages.map((s,i)=>[s,i]));
      const skip = Array.from({length:stages.length},()=>0);
      for (let row = 0; row < slots.length; ++row) {
        html += `<div class="timeline-time">${slots[row]}</div>`;
        for (let st = 0; st < stages.length; ++st) {
          if (skip[st] > 0) {
            skip[st]--;
            continue;
          }
          const ev = grid[row][st];
          if (ev) {
            // Calculate rowspan
            const startIdx = row;
            let span = 1;
            let curIdx = row + 1;
            const eventEnd = padTime(ev.end);
            while (curIdx < slots.length && slots[curIdx] < eventEnd) {
              span++;
              curIdx++;
            }
            skip[st] = span-1;
            html += `<div class="timeline-cell event stage-${ev.stage.toLowerCase()}" style="grid-row: span ${span};">
              <div class="event-title">${ev.title}</div>
              <div class="event-time">${ev.start}${ev.end!==ev.start?` &ndash; ${ev.end}`:''}</div>
              ${ev.extra_info?`<div class="event-info">${ev.extra_info}</div>`:''}
            </div>`;
          } else {
            html += `<div class="timeline-cell"></div>`;
          }
        }
      }

      html += `</div>`;
      return html;
    }

    function getAllStages(events) {
      // Return array of unique stages, sorted by a preferred order
      const stageSet = new Set(events.map(ev => ev.stage));
      const order = ['kaatsspelplein', 'viersprong', 'algemeen'];
      const stages = Array.from(stageSet);
      stages.sort((a, b) => order.indexOf(a) - order.indexOf(b));
      return stages;
    }

    function groupEventsByDate(events) {
      const grouped = {};
      for (const ev of events) {
        if (!grouped[ev.date]) grouped[ev.date] = [];
        grouped[ev.date].push(ev);
      }
      return grouped;
    }

    fetch('events.json')
      .then(r => r.json())
      .then(events => {
        const container = document.getElementById('timeline');
        const grouped = groupEventsByDate(events);
        let html = '';
        Object.entries(grouped).sort(([a], [b]) => a.localeCompare(b)).forEach(([date, evs]) => {
          const stages = getAllStages(evs);
          html += renderDayGrid(date, evs, stages, 30);
        });
        container.innerHTML = html;
      })
      .catch(err => {
        document.getElementById('timeline').innerHTML =
          "<p style='color:red'>Kon evenementen niet laden. Controleer het bestand 'events.json'.</p>";
        console.error(err);
      });
  </script>
</body>
</html>
