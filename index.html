<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patersholfeesten 2025 Programma</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Algemene variabelen en basisstijlen */
        :root {
            --background-color: #111;
            --text-color: #fff;
            --secondary-text-color: #ccc;
            --border-color: #444;
            --highlight-color: #EF4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.5;
            font-size: 16px;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 32px 16px;
        }

        .header {
            margin-bottom: 32px;
        }

        /* Nieuwe container om het logo en de titel uit te lijnen */
        .header-title-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        /* Stijl voor het logo */
        .patershol-logo {
            height: 60px; /* Pas de grootte van het logo aan */
            filter: invert(1); /* Inverteert de kleuren (wit wordt zwart, zwart wordt wit) */
        }
        
        h1 {
            font-size: 48px;
            font-weight: 800;
            margin: 0; /* Verwijder de standaardmarge om de uitlijning te verbeteren */
        }

        .description {
            font-size: 18px;
            color: var(--secondary-text-color);
        }

        .date-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 24px;
        }

        .date-button {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .date-button.active {
            background-color: var(--text-color);
            color: var(--background-color);
        }

        .date-button:not(.active) {
            background-color: #333;
            color: var(--text-color);
        }

        .date-button:not(.active):hover {
            background-color: #555;
        }

        /* Desktop Layout (Grid) */
        .schedule-grid-container {
            position: relative;
        }
        
        .stage-labels {
            display: grid;
            font-weight: 700;
            color: var(--secondary-text-color);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background-color: var(--background-color);
            z-index: 20;
        }
        
        .stage-labels > div {
            padding: 16px;
        }
        
        .schedule-container {
            display: grid;
            /* 15 minuten per rij = 24px */
            grid-auto-rows: 24px;
            position: relative;
            grid-template-columns: 80px repeat(var(--stages), minmax(0, 1fr));
        }

        .time-label {
            grid-column: 1;
            position: relative;
            padding-top: 4px;
            font-size: 12px;
            color: #999;
            border-right: 1px solid var(--border-color);
            z-index: 10;
        }
        
        .stage-line {
            border-left: 1px solid var(--border-color);
            margin-left: -1px;
        }

        .hour-line {
            position: absolute;
            width: 100%;
            height: 1px;
            background-color: var(--border-color);
            left: 0;
            z-index: 5;
        }
        
        .event-card {
            margin: 4px;
            padding: 8px;
            border-radius: 8px;
            font-weight: 600;
            overflow: hidden;
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .event-card:hover {
            transform: scale(1.03);
        }

        .event-title {
            color: var(--text-color);
            font-size: 14px;
            font-weight: 700;
        }

        .event-time {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--secondary-text-color);
        }

        .event-info {
            font-size: 9px;
            color: #bbb;
            margin-top: 4px;
        }
        
        .loading-text {
            color: var(--text-color);
            font-style: italic;
        }

        /* De rode lijn die de huidige tijd aangeeft */
        .current-time-line {
            position: absolute;
            height: 2px;
            background-color: var(--highlight-color);
            width: 100%;
            left: 0;
            z-index: 30;
        }
        
        /* Mobile Layout */
        @media (max-width: 768px) {
            h1 {
                font-size: 32px; /* Verkleinde font-size voor mobiel */
            }
            
            .patershol-logo {
                height: 40px; /* Pas de grootte van het logo aan voor mobiel */
            }

            .date-button {
                width: 100%; /* Make buttons take full width */
                text-align: center; /* Center the text */
                box-sizing: border-box; /* Include padding and border in the element's total width and height */
            }

            .schedule-grid-container {
                display: flex;
                flex-direction: column;
                gap: 24px;
            }
            
            .stage-labels, .schedule-container {
                display: none; /* Desktop grid verbergen op mobiel */
            }

            .mobile-stage-header {
                font-size: 24px;
                font-weight: 700;
                padding: 16px 0 8px 0;
                border-bottom: 1px solid var(--border-color);
                margin-bottom: 8px;
            }

            .mobile-events-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .mobile-events-list .event-card {
                position: relative;
                width: auto;
                height: auto;
                margin: 0;
            }
            
            /* NIEUWE STIJL VOOR AFGELOPEN EVENEMENTEN OP MOBIEL */
            .mobile-events-list .event-card.passed {
                filter: brightness(0.6); /* Maak de kaart donkerder */
            }
            
            /* Stijlen en animatie voor het oplichtende evenement op mobiel */
            @keyframes glowing-border {
                0% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.5), 0 0 10px rgba(239, 68, 68, 0.3); }
                50% { box-shadow: 0 0 10px rgba(239, 68, 68, 0.8), 0 0 20px rgba(239, 68, 68, 0.5); }
                100% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.5), 0 0 10px rgba(239, 68, 68, 0.3); }
            }

            .event-card.current {
                animation: glowing-border 2s infinite ease-in-out;
                border: 1px solid var(--highlight-color);
                z-index: 25;
            }
        }
    </style>
</head>
<body data-page-color="black">

    <div class="container">
        <header class="header">
            <div class="header-title-container">
                <img src="https://nicolaivr.github.io/Patersholfeesten2025/logoPatershol.svg" alt="Patershol Logo" class="patershol-logo">
                <h1 class="text-white">Patersholfeesten 2025</h1>
            </div>
            
            <div id="date-buttons" class="date-buttons">
                </div>
        </header>

        <div id="schedule-grid-container" class="schedule-grid-container">
            <div id="loading-message" style="display: flex; align-items: center; justify-content: center; height: 192px; color: #ccc;">Laden van het programma...</div>
            
            </div>
    </div>

    <script>
        const scheduleGridContainer = document.getElementById('schedule-grid-container');
        const loadingMessage = document.getElementById('loading-message');
        const dateButtonsContainer = document.getElementById('date-buttons');
        const scheduleUrl = 'https://nicolaivr.github.io/Patersholfeesten2025/events.json';

        let eventsData = [];
        let currentDay = null; // Start with no selected day
        let stages = [];
        let intervalId = null;

        // Nieuwe virtuele datum-variabele
        let virtueleDatumTijd = null;

        const weekDays = ['Zondag', 'Maandag', 'Dinsdag', 'Woensdag', 'Donderdag', 'Vrijdag', 'Zaterdag'];
        const months = ['jan', 'feb', 'mrt', 'apr', 'mei', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];

        // Functie om tijdstring (HH:MM) om te zetten in minuten vanaf middernacht
        const timeToMinutes = (time) => {
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        };
        
        // Functie om een datumstring te formatteren naar "Dag DD Mnd"
        const formatDate = (dateString) => {
            const date = new Date(dateString);
            const dayOfWeek = weekDays[date.getUTCDay()];
            const dayOfMonth = date.getUTCDate();
            const month = months[date.getUTCMonth()];
            return `${dayOfWeek} ${dayOfMonth} ${month}`;
        };

        // Functie om de datumknoppen dynamisch te renderen
        const renderDateButtons = (dates) => {
            dateButtonsContainer.innerHTML = ''; // Clear existing buttons
            dates.forEach((dateString, index) => {
                const button = document.createElement('button');
                button.id = `day-${index + 1}`;
                button.className = 'date-button';
                button.textContent = formatDate(dateString);
                button.dataset.date = dateString; // Sla de volledige datum op in een data-attribuut

                // Bepaal of deze knop de actieve moet zijn
                if (dateString === currentDay) {
                    button.classList.add('active');
                }
                
                button.addEventListener('click', () => {
                    currentDay = dateString;
                    document.querySelectorAll('.date-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderSchedule(currentDay);
                });

                dateButtonsContainer.appendChild(button);
            });
        };

        // Functie om de evenementengegevens op te halen van de opgegeven URL en cache te omzeilen
        const loadEvents = async () => {
            try {
                const cacheBuster = new Date().getTime();
                const urlWithBuster = `${scheduleUrl}?t=${cacheBuster}`;
                const response = await fetch(urlWithBuster);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    eventsData = data;
                    stages = [...new Set(eventsData.map(event => event.stage))].sort();
                    const uniqueDates = [...new Set(eventsData.map(event => event.date))].sort();
                    
                    if (uniqueDates.length > 0) {
                        const firstEventDate = new Date(uniqueDates[0]);
                        const festivalYear = firstEventDate.getFullYear();

                        document.querySelector('h1.text-white').textContent = `Patersholfeesten ${festivalYear}`;
                        document.title = `Patersholfeesten ${festivalYear} Programma`;
                    }

                    const now = virtueleDatumTijd ? virtueleDatumTijd : new Date();
                    const today = now.toISOString().split('T')[0];
                    const todayIndex = uniqueDates.indexOf(today);
                    
                    currentDay = todayIndex !== -1 ? today : uniqueDates[0];

                    renderDateButtons(uniqueDates);
                    renderSchedule(currentDay);
                    startLiveTimeLine();
                } else {
                    throw new Error('Ongeldig dataformaat: De respons is geen array.');
                }
            } catch (error) {
                console.error("Could not fetch or parse events data:", error);
                loadingMessage.innerHTML = 'Fout bij het laden van de evenementen. Controleer de data of probeer het later opnieuw.';
                loadingMessage.style.color = '#EF4444';
            }
        };

        /**
         * Functie om de virtuele tijd in te stellen.
         * @param {string} datetimeString - De gewenste datum en tijd in het formaat 'YYYY-MM-DD HH:mm:ss'.
         * Voorbeeld: '2025-08-16 19:30:00'
         */
        function stelVirtueleTijdlijnTijdIn(datetimeString) {
            const parsedDate = new Date(datetimeString);

            if (isNaN(parsedDate.getTime())) {
                console.error("Ongeldig datumformaat. Gebruik 'YYYY-MM-DD HH:mm:ss', bijvoorbeeld '2025-08-16 19:30:00'.");
                return;
            }

            virtueleDatumTijd = parsedDate;
            console.log(`De virtuele tijd is ingesteld op ${datetimeString}. De tijdlijn zal nu deze tijd gebruiken.`);
            
            // Zet de geselecteerde dag op basis van de virtuele datum
            currentDay = virtueleDatumTijd.toISOString().split('T')[0];
            
            renderSchedule(currentDay);
            // Je kunt handmatig een herhaalde update instellen als je een animatie wilt zien.
            // Omdat de virtuele tijd statisch is, wordt de live tijdslijn niet automatisch bijgewerkt.
        }

        /**
         * Reset de virtuele tijd en keert terug naar de echte systeemklok.
         */
        function resetVirtueleTijdlijnTijd() {
            virtueleDatumTijd = null;
            console.log("De virtuele tijd is gereset. De tijdlijn gebruikt nu de echte systeemklok.");
            // Herlaad de pagina om zeker te zijn van een schone start.
            window.location.reload();
        }

        // Functie om de rode tijdslijn bij te werken en het huidige evenement te markeren
        const updateTimeLine = () => {
            const now = virtueleDatumTijd ? virtueleDatumTijd : new Date();
            const today = now.toISOString().split('T')[0];
            const timeLines = document.querySelectorAll('.current-time-line');
            const eventCards = document.querySelectorAll('.event-card');
            
            // Verwijder 'current' en 'passed' classes van alle kaarten
            eventCards.forEach(card => {
                card.classList.remove('current');
                card.classList.remove('passed');
            });
            
            const isToday = currentDay === today;
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const isMobile = window.innerWidth <= 768;

            if (isToday) {
                // Vind het startmoment van de kalender om de positie van de rode lijn te berekenen
                const firstEvent = eventsData.filter(event => event.date === currentDay).sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start))[0];
                const newStartMinutes = firstEvent ? Math.max(0, timeToMinutes(firstEvent.start) - 60) : 0;
                
                if (!isMobile) {
                    const topPosition = ((currentMinutes - newStartMinutes) / 15) * 24;
                    timeLines.forEach(line => {
                        // Only show the line if the current time is after the grid starts (1h before first event)
                        if (currentMinutes >= newStartMinutes) {
                            line.style.top = `${topPosition}px`;
                            line.style.display = 'block';
                        } else {
                            line.style.display = 'none';
                        }
                    });
                } else {
                    timeLines.forEach(line => line.style.display = 'none');
                }

                eventCards.forEach(card => {
                    const eventDate = card.dataset.date;
                    const startTimeMinutes = timeToMinutes(card.dataset.start);
                    const endTimeMinutes = timeToMinutes(card.dataset.end);
                    
                    if (currentMinutes >= startTimeMinutes && currentMinutes < endTimeMinutes) {
                        card.classList.add('current');
                    }
                    
                    if (isMobile && eventDate === today) {
                        const isNormalEvent = startTimeMinutes < endTimeMinutes;
                        const isSameTimeEvent = startTimeMinutes === endTimeMinutes;

                        if (isNormalEvent && currentMinutes >= endTimeMinutes) {
                            card.classList.add('passed');
                        }    
                        else if (isSameTimeEvent && currentMinutes >= startTimeMinutes + 60) {
                            card.classList.add('passed');
                        }
                    }
                });
            } else {
                timeLines.forEach(line => line.style.display = 'none');
            }
        };

        // Functie om de live tijdslijn update te starten
        const startLiveTimeLine = () => {
            if (intervalId) {
                clearInterval(intervalId);
            }
            updateTimeLine();
            intervalId = setInterval(() => {
                if (!virtueleDatumTijd) {
                    updateTimeLine();
                }
            }, 60000);    
        };

        // Functie om het programma te renderen op basis van de geselecteerde datum
        const renderSchedule = (date) => {
            loadingMessage.style.display = 'none';
            scheduleGridContainer.innerHTML = '';
            
            const isMobile = window.innerWidth <= 768;
            const filteredEvents = eventsData.filter(event => event.date === date);

            if (isMobile) {
                stages.forEach(stage => {
                    const stageDiv = document.createElement('div');
                    stageDiv.innerHTML = `<h2 class="mobile-stage-header">${stage.charAt(0).toUpperCase() + stage.slice(1)}</h2>`;

                    const stageEventsList = document.createElement('div');
                    stageEventsList.className = 'mobile-events-list';

                    const stageEvents = filteredEvents.filter(event => event.stage === stage)
                                                    .sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));
                    
                    stageEvents.forEach(event => {
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'event-card';
                        eventDiv.style.backgroundColor = getEventColor(event.stage);
                        eventDiv.dataset.start = event.start;
                        eventDiv.dataset.end = event.end;
                        eventDiv.dataset.date = event.date;
                        eventDiv.innerHTML = `
                            <div>
                                <div class="event-title">${event.title}</div>
                                <div class="event-time">${event.start} - ${event.end}</div>
                                ${event.extra_info ? `<div class="event-info">${event.extra_info}</div>` : ''}
                            </div>
                        `;
                        stageEventsList.appendChild(eventDiv);
                    });
                    
                    stageDiv.appendChild(stageEventsList);
                    scheduleGridContainer.appendChild(stageDiv);
                });

            } else {
                if (filteredEvents.length === 0) {
                    scheduleGridContainer.innerHTML = '<div style="text-align: center; color: #ccc;">Geen evenementen voor deze dag.</div>';
                    return;
                }

                const sortedEvents = filteredEvents.sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));
                const firstEvent = sortedEvents[0];
                let lastEventMinutes = 0;
                
                sortedEvents.forEach(event => {
                    let endMinutes = timeToMinutes(event.end);
                    // Check if event spans past midnight
                    if (timeToMinutes(event.end) < timeToMinutes(event.start)) {
                        endMinutes += 1440; // Add 24 hours in minutes
                    }
                    if (endMinutes > lastEventMinutes) {
                        lastEventMinutes = endMinutes;
                    }
                });
                
                // If there are no overnight events, set lastEventMinutes to the end of the last normal event
                if (lastEventMinutes <= timeToMinutes(sortedEvents[sortedEvents.length - 1].start) && timeToMinutes(sortedEvents[sortedEvents.length - 1].end) > timeToMinutes(sortedEvents[sortedEvents.length - 1].start)) {
                    lastEventMinutes = timeToMinutes(sortedEvents[sortedEvents.length - 1].end);
                } else if (lastEventMinutes <= timeToMinutes(sortedEvents[sortedEvents.length - 1].start) && timeToMinutes(sortedEvents[sortedEvents.length - 1].end) < timeToMinutes(sortedEvents[sortedEvents.length - 1].start)){
                     lastEventMinutes += 1440
                }
                
                const firstEventMinutes = timeToMinutes(firstEvent.start);
                const newStartMinutes = Math.max(0, firstEventMinutes - 60);
                
                const stageLabelsContainer = document.createElement('div');
                stageLabelsContainer.id = 'stage-labels';
                stageLabelsContainer.className = 'stage-labels';
                const gridTemplate = `80px repeat(${stages.length}, minmax(0, 1fr))`;
                stageLabelsContainer.style.gridTemplateColumns = gridTemplate;
                stageLabelsContainer.innerHTML = '<div style="border-right: 1px solid var(--border-color); padding: 16px;">Tijd</div>';
                stages.forEach(stage => {
                    const stageLabelDiv = document.createElement('div');
                    stageLabelDiv.textContent = stage.charAt(0).toUpperCase() + stage.slice(1);
                    stageLabelsContainer.appendChild(stageLabelDiv);
                });
                scheduleGridContainer.appendChild(stageLabelsContainer);
                
                const scheduleContainer = document.createElement('div');
                scheduleContainer.id = 'schedule-container';
                scheduleContainer.className = 'schedule-container';
                scheduleContainer.style.setProperty('--stages', stages.length);
                scheduleGridContainer.appendChild(scheduleContainer);
                
                const endHour = Math.ceil(lastEventMinutes / 60);

                for (let hour = Math.floor(newStartMinutes / 60); hour <= endHour; hour++) {
                    const displayHour = hour >= 24 ? hour - 24 : hour;
                    const relativeMinutes = (hour * 60) - newStartMinutes;
                    if (relativeMinutes < 0) continue;
                    
                    const hourLine = document.createElement('div');
                    hourLine.className = 'hour-line';
                    const topPosition = (relativeMinutes / 15) * 24;
                    hourLine.style.top = `${topPosition}px`;
                    scheduleContainer.appendChild(hourLine);
                    
                    const timeLabelDiv = document.createElement('div');
                    timeLabelDiv.className = `time-label`;
                    timeLabelDiv.style.gridRowStart = (relativeMinutes / 15) + 1;
                    timeLabelDiv.textContent = `${String(displayHour).padStart(2, '0')}:00`;
                    scheduleContainer.appendChild(timeLabelDiv);
                }
                
                const totalMinutes = lastEventMinutes - newStartMinutes;
                const totalRows = Math.ceil(totalMinutes / 15) + 1; // +1 to ensure it reaches the last line
                
                for (let i = 1; i <= stages.length; i++) {
                    const stageGridLine = document.createElement('div');
                    stageGridLine.className = `stage-line`;
                    stageGridLine.style.gridColumn = i + 1;
                    stageGridLine.style.gridRow = `1 / span ${totalRows}`;
                    scheduleContainer.appendChild(stageGridLine);
                }
                
                filteredEvents.forEach(event => {
                    const startTimeMinutes = timeToMinutes(event.start);
                    let endTimeMinutes = timeToMinutes(event.end);
                    
                    if (endTimeMinutes < startTimeMinutes) {
                        endTimeMinutes += 1440; // Add 24 hours for overnight events
                    }

                    const startRow = Math.floor((startTimeMinutes - newStartMinutes) / 15) + 1;
                    const endRow = Math.ceil((endTimeMinutes - newStartMinutes) / 15) + 1;
                    let rowSpan = endRow - startRow;
                    
                    if (rowSpan <= 0) {
                        rowSpan = 4;
                    }
                    
                    const stageIndex = stages.indexOf(event.stage) + 2;

                    const eventDiv = document.createElement('div');
                    eventDiv.className = `event-card`;
                    eventDiv.style.gridRow = `${startRow} / span ${rowSpan}`;
                    eventDiv.style.gridColumn = stageIndex;
                    eventDiv.style.backgroundColor = getEventColor(event.stage);
                    eventDiv.dataset.start = event.start;
                    eventDiv.dataset.end = event.end;
                    eventDiv.dataset.date = event.date;
                    
                    eventDiv.innerHTML = `
                        <div>
                            <div class="event-title">${event.title}</div>
                            <div class="event-time">${event.start} - ${event.end}</div>
                            ${event.extra_info ? `<div class="event-info">${event.extra_info}</div>` : ''}
                        </div>
                    `;
                    scheduleContainer.appendChild(eventDiv);
                });

                const timeLine = document.createElement('div');
                timeLine.className = 'current-time-line';
                scheduleContainer.appendChild(timeLine);
            }
            
            updateTimeLine();
        };

        const getEventColor = (stage) => {
            const colors = ['#333', '#555', '#777', '#999'];
            const stageIndex = stages.indexOf(stage);
            return colors[stageIndex % colors.length];
        };

        const init = () => {
            loadEvents();
        };

        init();
        
        let isMobileLayout = window.innerWidth <= 768;

        window.addEventListener('resize', () => {
            const newIsMobileLayout = window.innerWidth <= 768;
            if (newIsMobileLayout !== isMobileLayout) {
                isMobileLayout = newIsMobileLayout;
                renderSchedule(currentDay);
            }
        });
    </script>
</body>
</html>
