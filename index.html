<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patersholfeesten 2025 — Verticale Tijdlijn</title>

  <style>
    :root { --header-h: 68px; --accent: #2e3d51; }
    html,body { height: 100%; margin: 0; }
    body { font-family: 'Montserrat', Arial, sans-serif; background: #f5f7fb; color:#111; }

    header {
      height: var(--header-h);
      background: var(--accent);
      color: #fff;
      display: flex;
      align-items: center;
      padding: 0 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      gap: 1rem;
    }
    header h1 { margin: 0; font-size: 1.1rem; font-weight: 700; letter-spacing: 1px; }
    header p { margin: 0; font-size: 0.9rem; opacity: 0.9; }

    /* calendar container fills remaining viewport */
    #calendar {
      height: calc(100vh - var(--header-h));
      width: 100%;
      box-sizing: border-box;
      padding: 0.5rem;
      background: #fff;
    }

    /* small visual tweaks */
    .fc .fc-event { white-space: normal; color: inherit; }
    .fc .fc-col-header-cell-cushion { font-weight:600; }

    /* error box */
    .error-box {
      max-width: 1100px;
      margin: 1rem auto;
      background: #fff6f6;
      border: 1px solid #f0a8a8;
      color: #7a1b1b;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.03);
      font-size: 0.95rem;
    }
    .btn {
      display:inline-block;padding:0.45rem 0.75rem;border-radius:6px;border:none;background:var(--accent);color:#fff;cursor:pointer;margin-right:0.5rem;
    }
    .btn.secondary { background:transparent;color:var(--accent);border:1px solid var(--accent); }
  </style>
</head>
<body>
  <header>
    <h1>Patersholfeesten 2025</h1>
    <p>Verticale tijdslijn — Overzicht per podium (tijd onder elkaar)</p>
  </header>

  <main id="main">
    <div id="calendar" aria-live="polite"></div>
    <div id="error" style="display:none;"></div>
  </main>

  <!-- IMPORTANT: load core first, then timegrid, then resource-timegrid (matching versions) -->
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.19/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.19/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/resource-timegrid@6.1.19/index.global.min.js"></script>
  <!-- locales (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.19/locales-all.global.min.js"></script>

  <script>
    // ---------- configuration ----------
    const stages = [
      { id: 'kaatsspelplein', title: 'Kaatsspelplein' },
      { id: 'viersprong', title: 'Viersprong' },
      { id: 'algemeen', title: 'Algemeen' }
    ];

    // ---------- helpers ----------
    function normalizeTime(t) {
      if (t === undefined || t === null || t === '') return null;
      t = String(t).trim();
      if (t.includes(':')) {
        const parts = t.split(':').map(p => p.padStart(2,'0'));
        while (parts.length < 3) parts.push('00');
        return parts.slice(0,3).join(':');
      }
      const digits = t.replace(/\D/g, '');
      if (digits.length <= 2) return digits.padStart(2,'0') + ':00:00';
      if (digits.length === 3) return digits.slice(0,1).padStart(2,'0') + ':' + digits.slice(1).padEnd(2,'0') + ':00';
      return digits.slice(0,2) + ':' + digits.slice(2,4) + ':00';
    }
    function hourFromTime(timeStr) {
      if (!timeStr) return null;
      const h = parseInt(timeStr.split(':')[0], 10);
      return Number.isFinite(h) ? h : null;
    }
    function addMinutesToIsoLocal(dtStr, minutes) {
      const d = new Date(dtStr);
      if (isNaN(d)) return dtStr;
      d.setMinutes(d.getMinutes() + minutes);
      const YYYY = d.getFullYear();
      const MM = String(d.getMonth()+1).padStart(2,'0');
      const DD = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const ss = String(d.getSeconds()).padStart(2,'0');
      return `${YYYY}-${MM}-${DD}T${hh}:${mm}:${ss}`;
    }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // ---------- error UI ----------
    function showError(title, message, details) {
      const c = document.getElementById('error');
      c.style.display = 'block';
      c.innerHTML = `
        <div class="error-box" role="alert">
          <strong>${escapeHtml(title)}</strong>
          <div style="margin-top:0.4rem">${escapeHtml(message)}</div>
          ${details ? `<pre style="margin-top:0.6rem;padding:0.6rem;background:#fff;border-radius:6px;border:1px solid #eee;white-space:pre-wrap">${escapeHtml(details)}</pre>` : ''}
          <div style="margin-top:0.75rem">
            <button id="retryBtn" class="btn">Retry</button>
            <button id="tipsBtn" class="btn secondary">Tips</button>
          </div>
        </div>`;
      document.getElementById('retryBtn').onclick = () => { c.style.display='none'; document.getElementById('calendar').innerHTML=''; init(); };
      document.getElementById('tipsBtn').onclick = () => {
        alert('Tips:\n• Plaats events.json in dezelfde map als deze HTML of wijzig het pad in de code.\n• Controleer DevTools Network voor HTTP/CORS fouten.\n• Zorg dat events.json valide JSON is (geen trailing commas, geen "...").');
      };
    }

    // ---------- fetch + init ----------
    async function fetchEventsJson() {
      const url = 'events.json';
      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) {
        const txt = await resp.text().catch(()=> '');
        throw new Error(`HTTP ${resp.status} ${resp.statusText}${txt ? ' — ' + txt : ''}`);
      }
      let data;
      try { data = await resp.json(); }
      catch(err) { throw new Error('Invalid JSON: ' + err.message); }
      if (!Array.isArray(data)) throw new Error('Expected events.json to be a JSON array.');
      return data;
    }

    async function init() {
      try {
        const raw = await fetchEventsJson();

        // normalize and map
        const events = raw.map((ev, idx) => {
          if (!ev.date) { console.warn('Skipping event without date:', ev); return null; }
          const startNorm = normalizeTime(ev.start);
          const endNorm = normalizeTime(ev.end);
          const startIso = startNorm ? `${ev.date}T${startNorm}` : null;
          let endIso = endNorm ? `${ev.date}T${endNorm}` : null;

          if (!endIso && startIso) endIso = addMinutesToIsoLocal(startIso, 60);
          if (startIso && endIso && startIso === endIso) endIso = addMinutesToIsoLocal(endIso, 1);

          return {
            id: `${(ev.title||'')}-${ev.date}-${ev.stage||''}-${idx}`,
            resourceId: ev.stage,
            title: (ev.title || '') + (ev.extra_info ? ' — ' + ev.extra_info : ''),
            start: startIso || '',
            end: endIso || ''
          };
        }).filter(x => x !== null);

        if (events.length === 0) throw new Error('No valid events found in events.json.');

        // compute vertical slot range from events
        const starts = raw.map(ev => hourFromTime(normalizeTime(ev.start))).filter(x=>x!==null);
        const ends = raw.map(ev => hourFromTime(normalizeTime(ev.end))).filter(x=>x!==null);
        const minHour = starts.length ? Math.max(0, Math.min(...starts)) : 8;
        const maxHourRaw = ends.length ? Math.max(...ends) : 22;
        const maxHour = Math.min(24, maxHourRaw + 2);

        // create calendar with resourceTimeGrid (vertical time)
        // NOTE: do NOT use a plugins: [...] array when using the global bundles,
        // the bundles already register the views / plugins on the FullCalendar global.
        const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
          initialView: 'resourceTimeGridDay',
          locale: 'nl',
          height: '100%',
          nowIndicator: true,

          // resource area
          resourceAreaHeaderContent: 'Podium',
          resources: stages,

          events,
          // vertical time axis settings
          slotMinTime: String(minHour).padStart(2,'0') + ':00:00',
          slotMaxTime: String(maxHour).padStart(2,'0') + ':00:00',
          slotDuration: '00:30:00',

          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'resourceTimeGridDay,resourceTimeGridWeek'
          },
          views: {
            resourceTimeGridDay: { buttonText: 'Dag' },
            resourceTimeGridWeek: { buttonText: 'Week' }
          },

          eventDidMount(info) {
            const rid = info.event.extendedProps.resourceId;
            if (rid === 'kaatsspelplein') { info.el.style.background = '#eafaf5'; info.el.style.borderColor = '#1abc9c'; }
            else if (rid === 'viersprong') { info.el.style.background = '#fcf3eb'; info.el.style.borderColor = '#e67e22'; }
            else if (rid === 'algemeen') { info.el.style.background = '#f2f5fa'; info.el.style.borderColor = '#2e3d51'; }
            info.el.style.color = '#111';
          },

          eventClick(info) {
            alert(info.event.title + '\n' + (info.event.start ? info.event.start.toLocaleString() : '') + ' → ' + (info.event.end ? info.event.end.toLocaleString() : ''));
          }
        });

        document.getElementById('error').style.display = 'none';
        calendar.render();
      } catch (err) {
        console.error(err);
        showError('Kon events.json niet laden', 'Controleer pad / CORS / JSON-syntaxis.', String(err.message || err));
      }
    }

    // start
    init();
  </script>
</body>
</html>
